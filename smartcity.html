<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SmartCity demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="stylesheet" href="/assets/smartcity.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-colorpicker/2.5.1/css/bootstrap-colorpicker.min.css">
</head>
<body>
    <div id="map"></div>

    <a href="https://www.omines.nl/" target="_blank">
        <img src="/assets/omines-logo.png" id="logo" alt="Omines Full Service Internetbureau">
    </a>

    <a href="https://github.com/omines/scdp-demo"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIFk4mYOt6vJtpY903qGgv6Ptz6GsusR0&amp;callback=initialize"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/restful.js/0.9.6/restful.standalone.min.js" integrity="sha256-7qyfP7fFatBNkzItfiResIKBA1R3vNHnRqVor/831Qg=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-colorpicker/2.5.1/js/bootstrap-colorpicker.min.js"></script>
    <script src="/assets/smartcity.js"></script>
    <script>
        const api = restful('https://smartcity-api.omines.nl'),
              strijp = {lat: 51.4466557, lng: 5.4585012};

        /**
         * Initializes the demo, automatically invoked by Google Maps API after it is loaded.
         */
        function initialize() {
            map = new google.maps.Map(document.getElementById('map'), {
                disableDefaultUI: true,
                zoom: 17,
                center: strijp,
                mapTypeControl: false,
                streetViewControl: false,
                styles: [{
                    "featureType": "poi",
                    "stylers": [ { "visibility": "off" } ]
                }]
            });

            // Connect to the SCDP API
            api.header('Accept', 'application/json');
            api.addErrorInterceptor(function(err, config) {
                console.error(err);
                return [err.message];
            });

            // Authenticate with an access token
            api.custom('authenticate').post({
                user: 'Niels',
                accessToken: 'f89r9mu889'
            }).then((response) => {
                api.header('Authorization', 'Bearer ' + response.body().data().token);

                // Subscribe to the datasets
                subscribeDataset('strijp-security-events', processSecurityEvent);
                subscribeDataset('strijp-streetlights', processStreetlightEvent).then((oneApi) => {
                    // Retrieve the initial data for the streetlights so we can show them
                    oneApi.all('records').getAll({limit: 1000}).then(function(response) {
                        const records = response.body().data().results;
                        console.log(records);
                        records.forEach(function(r) {
                            placeStreetlight(r);
                        });
                    });
                });
            });
            console.log('Init streetlights');
            //placeStreetlights();
        }

        /**
         * Subscribe to a single dataset. The supplied callback is invoked with changes to the dataset, a promise is
         * returned that will resolve to the API endpoint for the dataset once it is resolved.
         */
        function subscribeDataset(name, callback) {
            return new Promise((resolve, reject) => {
                api.all('datasets').getAll({name: name}).then((response) => {
                    const body = response.body(), dataset = body[0].data();
                    console.info('Found dataset ' + name + ' with GUID ' + dataset.id);

                    let oneApi = api.one('datasets', dataset.id);
                    resolve(oneApi);
                    oneApi.custom('stream').get().then((response) => {
                        const stream = response.body().data();
                        const socket = new WebSocket(stream.url);
                        socket.onmessage = callback;
                        socket.onerror = function(e) { console.log('Error', e)};
                        socket.onclose = function(e) { console.log('Close', e)};
                    });
                });
            });
        }

        function processSecurityEvent(e) {
            var data = jQuery.parseJSON(e.data);
            var id = data.record._id.$oid;
            var found = false;
            for (i=0;i<securityAlertMarkers.length;i++) {
                if (securityAlertMarkers[i].id == id) {
                    found = true;
                    break;
                }
            }

            if (found) {
                console.log('Marker already exists');
            }
            else {
                var alertMarker = new google.maps.Marker(Object.assign({'title':data.record.message}, {
                    position: {
                        'lng': data.record.location.coordinates[0],
                        'lat': data.record.location.coordinates[1]
                    },
                    map: map,
                    draggable: false,
                    icon: getArrowIcon(1)
                }));
                var alertInfoWindow = new google.maps.InfoWindow({
                    content: '<h4>' + data.record.message + '</h4>'
                    + new Date(data.record.timestamp).toLocaleString()
                    + '<br/>'
                    + '<form></form>'
                });
                alertMarker.addListener('click', function() {
                    alertInfoWindow.open(map, alertMarker);
                });

                securityAlertMarkers.unshift({
                    id: id,
                    marker: alertMarker
                });
                securityAlertInfoWindows.unshift(alertInfoWindow);

                if (securityAlertMarkers.length > 10) {
                    securityAlertMarkers.pop().marker.setMap(null);
                    securityAlertInfoWindows.pop();
                }

                for (i=1;i<securityAlertMarkers.length;i++) {
                    // we will reduce opacity of all older alerts
                    securityAlertMarkers[i].marker.setIcon(getArrowIcon(1 - (i*0.1)));
                }
            }
        }

        function processStreetlightEvent(e)
        {
            console.log(e);
        }
    </script>
</body>
</html>
